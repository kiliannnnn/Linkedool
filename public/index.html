<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Linkedool UI</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.5/dist/purify.min.js"></script>
</head>
<body>
  <div class="page">
    <header class="hero">
      <div>
        <p class="eyebrow">LinkedIn Profile Auditor</p>
        <h1>Linkedool UI</h1>
      </div>
      <div class="pill">Local & Cloud · Private · AI-Powered</div>
    </header>

    <main class="layout">
      <section class="panel">
        <form id="analyze-form" enctype="multipart/form-data">
          <div class="form-columns">
            <!-- Left Column: User / LinkedIn Info -->
            <div class="form-column">
              <h3>LinkedIn Profile</h3>
              <div class="field-group">
                <label class="label">Profile source</label>
                <div class="choices">
                  <label><input type="radio" name="source" value="text" checked /> Paste text</label>
                  <label><input type="radio" name="source" value="pdf" /> PDF</label>
                  <label><input type="radio" name="source" value="html" /> HTML</label>
                </div>
              </div>

              <div class="field-group source-section" data-source="text">
                <label class="label" for="profileText">Profile text</label>
                <textarea id="profileText" name="profileText" rows="8" placeholder="Paste LinkedIn profile text here..."></textarea>
              </div>

              <div class="field-group source-section hidden" data-source="pdf">
                <label class="label" for="profilePdf">Profile PDF</label>
                <input id="profilePdf" name="profilePdf" type="file" accept="application/pdf" />
              </div>

              <div class="field-group source-section hidden" data-source="html">
                <label class="label" for="profileHtml">Profile HTML</label>
                <input id="profileHtml" name="profileHtml" type="file" accept="text/html,.html" />
              </div>

            </div>

            <!-- Right Column: AI Configuration -->
            <div class="form-column">
              <h3>AI Configuration</h3>
              <div class="field-group">
                <label class="label" for="provider">AI Provider</label>
                <select id="provider" name="provider">
                  <option value="ollama">Ollama (Local)</option>
                  <option value="openai">OpenAI</option>
                </select>
              </div>

              <div id="ollama-section" class="provider-section">
                <div class="field-group">
                  <label class="label" for="ollamaHost">Ollama host</label>
                  <input id="ollamaHost" name="host" type="text" value="http://localhost:11434" />
                </div>
                <div class="field-group">
                  <label class="label" for="model">Model</label>
                  <div class="inline">
                    <select id="model" name="model">
                      <option value="llama3">llama3</option>
                    </select>
                    <button type="button" id="load-models">Load</button>
                  </div>
                </div>
              </div>

              <div id="openai-section" class="provider-section hidden">
                <div class="field-group">
                  <label class="label" for="openaiKey">API Key</label>
                  <input id="openaiKey" name="apiKey" type="password" placeholder="sk-..." />
                </div>
                <div class="field-group">
                  <label class="label" for="openaiModel">Model</label>
                  <input id="openaiModel" name="openaiModel" type="text" value="gpt-4" />
                </div>
              </div>
            </div>
          </div>

          <div class="actions">
            <button type="submit" id="submit-btn">Analyze</button>
            <span id="status" aria-live="polite"></span>
          </div>
        </form>
      </section>

      <section class="panel results">
        <div class="results-header">
          <h2>Results</h2>
          <button id="clear-btn" type="button">Clear</button>
        </div>
        <div id="results" class="results-body">
          <p class="muted">Run an analysis to see scores and AI feedback.</p>
        </div>
      </section>
    </main>
  </div>

  <script>
    const sourceRadios = document.querySelectorAll('input[name="source"]');
    const sections = document.querySelectorAll('.source-section');
    const form = document.getElementById('analyze-form');
    const statusEl = document.getElementById('status');
    const submitBtn = document.getElementById('submit-btn');
    const resultsEl = document.getElementById('results');
    const clearBtn = document.getElementById('clear-btn');
    const modelSelect = document.getElementById('model');
    const loadModelsBtn = document.getElementById('load-models');
    const hostInput = document.getElementById('ollamaHost');
    const providerSelect = document.getElementById('provider');
    const ollamaSection = document.getElementById('ollama-section');
    const openaiSection = document.getElementById('openai-section');

    function setStatus(message, tone = 'info') {
      statusEl.textContent = message;
      statusEl.dataset.tone = tone;
    }

    function toggleSources() {
      const selected = document.querySelector('input[name="source"]:checked').value;
      sections.forEach((section) => {
        section.classList.toggle('hidden', section.dataset.source !== selected);
      });
    }

    function toggleProviders() {
      const selected = providerSelect.value;
      ollamaSection.classList.toggle('hidden', selected !== 'ollama');
      openaiSection.classList.toggle('hidden', selected !== 'openai');
      if (selected === 'ollama') loadModels();
    }

    sourceRadios.forEach((r) => r.addEventListener('change', toggleSources));
    toggleSources();

    providerSelect.addEventListener('change', toggleProviders);
    toggleProviders();

    clearBtn.addEventListener('click', () => {
      resultsEl.innerHTML = '<p class="muted">Cleared. Submit again to see results.</p>';
      setStatus('');
    });

    async function loadModels() {
      const host = hostInput.value.trim();
      setStatus('Loading models...');
      loadModelsBtn.disabled = true;
      try {
        const res = await fetch(`/api/models?host=${encodeURIComponent(host)}`);
        const json = await res.json();
        if (!res.ok) throw new Error(json.error || 'Unable to load models');
        modelSelect.innerHTML = '';
          if (!json.models || json.models.length === 0) {
            throw new Error('No models found at this host');
          }
        (json.models || []).forEach((m) => {
          const opt = document.createElement('option');
          opt.value = m.name;
          opt.textContent = m.name;
          modelSelect.appendChild(opt);
        });
        if (!modelSelect.value && modelSelect.options.length > 0) {
          modelSelect.selectedIndex = 0;
        }
        setStatus(`Loaded ${json.models?.length || 0} models from ${json.host}`);
      } catch (err) {
        setStatus(err.message || 'Failed to load models', 'error');
      } finally {
        loadModelsBtn.disabled = false;
      }
    }

    loadModelsBtn.addEventListener('click', loadModels);

    function clampScore(n) {
      const num = Number(n);
      if (Number.isNaN(num)) return null;
      return Math.min(100, Math.max(0, num));
    }

    function parseScores(text) {
      if (!text) return { overall: null, sections: [] };
      const scoreMap = new Map();
      // Match patterns like "Overall Score: [X]/100" or "- Overall Score: X"
        const scorePattern = /([\w\s]+)\s*:?\s*(\d{1,3})\s*\/100/gi;
      let match;
      while ((match = scorePattern.exec(text)) !== null) {
        const key = match[1].trim().toLowerCase();
        const score = clampScore(match[2]);
        scoreMap.set(key, score);
      }
      
      const overall = scoreMap.get('overall score') || scoreMap.get('overall') || null;
      const sectionNames = ['Headline', 'About', 'Experience', 'Skills', 'Education'];
      const sections = sectionNames
        .map((name) => {
          const key = `${name.toLowerCase()} score`;
          const score = scoreMap.get(key);
          return score !== undefined ? { name, score } : null;
        })
        .filter(Boolean);
      return { overall, sections };
    }

    function scoreCard(title, score, emphasize = false) {
      if (score === null || score === undefined) return '';
      const width = `${score}%`;
      return `
        <div class="score-card${emphasize ? ' overall' : ''}">
          <div class="score-top">
            <div class="score-title">${title}</div>
            <div class="score-value">${score}</div>
          </div>
          <div class="score-bar"><span style="width:${width}"></span></div>
        </div>
      `;
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function renderResults(data) {
      const { llmReport, model, host } = data;
      const { overall, sections } = parseScores(llmReport || '');

      const overallCard = overall !== null ? scoreCard('Overall', overall, true) : '';
      const sectionCards = sections.map((s) => scoreCard(s.name, s.score)).join('');

      resultsEl.innerHTML = `
        ${overallCard || '<p class="muted">No scores parsed from AI output.</p>'}
        <div class="score-grid">${sectionCards}</div>
        <div class="llm llm-md">${llmReport ? DOMPurify.sanitize(marked.parse(llmReport)) : '<p class="muted">No feedback returned.</p>'}</div>
      `;
    }

    let streamController = null;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setStatus('Preparing request...');
      submitBtn.disabled = true;

      // Abort any previous stream
      if (streamController) {
        streamController.abort();
      }
      streamController = new AbortController();

      try {
        const formData = new FormData();
        const source = document.querySelector('input[name="source"]:checked').value;
        const provider = providerSelect.value;

        if (source === 'text') {
          const text = document.getElementById('profileText').value.trim();
          if (!text) throw new Error('Please paste profile text.');
          formData.append('profileText', text);
        } else if (source === 'pdf') {
          const file = document.getElementById('profilePdf').files[0];
          if (!file) throw new Error('Select a profile PDF.');
          formData.append('profilePdf', file);
        } else if (source === 'html') {
          const file = document.getElementById('profileHtml').files[0];
          if (!file) throw new Error('Select a profile HTML file.');
          formData.append('profileHtml', file);
        }

        formData.append('provider', provider);
        if (provider === 'ollama') {
          const model = modelSelect.value.trim();
          const host = hostInput.value.trim();
          if (model) formData.append('model', model);
          if (host) formData.append('host', host);
        } else if (provider === 'openai') {
          const apiKey = document.getElementById('openaiKey').value.trim();
          const model = document.getElementById('openaiModel').value.trim();
          if (!apiKey) throw new Error('OpenAI API key required.');
          formData.append('apiKey', apiKey);
          if (model) formData.append('model', model);
        }

        setStatus('Streaming response...');
        
        // Clear results and prepare for streaming
        resultsEl.innerHTML = '<div class="llm llm-md streaming"></div>';
        const streamingDiv = resultsEl.querySelector('.llm-md');
        let fullText = '';

        const res = await fetch('/api/analyze-stream', {
          method: 'POST',
          body: formData,
          signal: streamController.signal
        });

        if (!res.ok) {
          throw new Error(`Request failed: ${res.status} ${res.statusText}`);
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value, { stream: true });
          const lines = chunk.split('\n');

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.substring(6);
              try {
                const parsed = JSON.parse(data);
                if (parsed.error) {
                  throw new Error(parsed.error + (parsed.details ? `: ${parsed.details}` : ''));
                }
                if (parsed.chunk) {
                  fullText += parsed.chunk;
                  // Render markdown progressively
                  streamingDiv.innerHTML = DOMPurify.sanitize(marked.parse(fullText));
                  streamingDiv.scrollTop = streamingDiv.scrollHeight;
                }
                if (parsed.done) {
                  // Parse scores from final text
                  const { overall, sections } = parseScores(fullText);
                  const overallCard = overall !== null ? scoreCard('Overall', overall, true) : '';
                  const sectionCards = sections.map((s) => scoreCard(s.name, s.score)).join('');
                  
                  resultsEl.innerHTML = `
                    ${overallCard || '<p class="muted">No scores parsed from AI output.</p>'}
                    <div class="score-grid">${sectionCards}</div>
                    <div class="llm llm-md">${DOMPurify.sanitize(marked.parse(fullText))}</div>
                  `;
                }
              } catch (parseErr) {
                console.warn('Failed to parse SSE data:', parseErr);
              }
            }
          }
        }

        setStatus('Done', 'success');
      } catch (err) {
        if (err.name === 'AbortError') {
          setStatus('Cancelled', 'error');
        } else {
          console.error(err);
          setStatus(err.message || 'Error', 'error');
        }
      } finally {
        submitBtn.disabled = false;
        streamController = null;
      }
    });
  </script>
</body>
</html>
